<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>What makes good taste of wine?</title>
    <style>
        #wrapper {
            display: inline-block;
            width: 1600px;
        }

        div.container {
            display: inline-block;
            width: 390px;
            height: 420px;
            background-color: #e0e0e0;
            margin: 5px;
        }

        div.control {
            float: right;
        }

        div.checkb {
            margin: 2px 0 2px 0;
            width: 240px;
        }
    </style>
    <script type="text/javascript" src="d3/d3.js"></script>
</head>
<body>
<div id="wrapper"></div>
<div class="control">
    <input type="button" onclick="generateVis()" value="reload"/>
</div>
<script type="text/javascript">
    var dataset;
    var file = "wine_white.csv";
    var linearScale = d3.scale.linear().domain([0, 10]).range([0, 200]);

    var data_keys = [];
    var dsv = d3.dsv(";", "text/plain");
    dsv(file, function (data) {
        dataset = data
                .sort(function (a, b) {
                    return b["quality"] - a["quality"]
                })
                .filter(function (d, i) {
                    return i < 4;
                });    //Once loaded, copy to dataset.
        if (dataset.length > 0) {
            var keys = Object.keys(dataset[0]);
            for (var i = 0; i < keys.length; i++) {
                if (keys[i] == "quality") {
                    continue;
                }
                data_keys.push({key: keys[i], index: i});
            }
            d3.select(".control").append("div").selectAll("input").data(data_keys)
                    .enter()
                    .append("div").attr("class", "checkb")
                    .append('label')
                    .attr('for', function (d, i) {
                        return 'a' + i;
                    })
                    .text(function (d) {
                        return d.key;
                    })
                    .append("input")
                    .attr("checked", true)
                    .attr("type", "checkbox")
                    .attr("id", function (d, i) {
                        return 'a' + i;
                    })
                    .attr("onClick", "checkbox_click(this)");
            generateVis();
        }
    });
    function checkbox_click(obj) {
        var index = 0;
        if (obj.checked) {
            for (var i = 0; i < data_keys.length; i++) {
                if (obj.__data__.index < data_keys[i].index) {
                    index = i;
                    break;
                }
            }
            data_keys.splice(index, 0, obj.__data__);
        } else {
            for (var i = 0; i < data_keys.length; i++) {
                if (obj.__data__.key == data_keys[i].key) {
                    index = i;
                    break;
                }
            }
            data_keys.splice(index, 1);
        }
        console.dir(data_keys);
        updateVis();
    }
    function updateVis() {
        var container = d3.select("#wrapper").selectAll("div")
                .data(dataset);
        var svg = container
                .selectAll("svg")
                .data(function (d) {
                    var data_array = [];
                    data_keys.forEach(function (prop) {
                        data_array.push({data_key: prop.key, data_value: d[prop.key]});
                    });
                    return [data_array];
                }).select("g");

        var update_sel = svg.selectAll("path").data(function (d) {
                    var result = pie(d);
                    return result;
                }).attr("fill", function (d, i) {
                    return color(i);
                })
                .attr("d", arc)
                ;
        update_sel.enter().append("path")
                .attr("fill", function (d, i) {
                    return color(i);
                })
                .attr("d", arc);
        update_sel.exit().remove();

    }
    function generateVis() {
        var container = d3.select("#wrapper").selectAll("div")
                .data(dataset).enter().append("div").attr("class", "container");

        var svg = container
                .selectAll("svg")
                .data(function (d) {
                    var data_array = [];
                    data_keys.forEach(function (prop) {
                        data_array.push({data_key: prop.key, data_value: d[prop.key]});
                    });
                    return [data_array];
                })
                .enter()
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        var update_sel = svg.selectAll("path").data(function (d) {
                    var result = pie(d);
                    return result;
                });

        update_sel.enter().append("path")
                .attr("fill", function (d, i) {
                    return color(i);
                })
                .attr("d", arc);
        container.append("p").text(function (d) {
            return d["quality"]
        });
    }

    var width = 300;
    var height = 300;
    var radius = height / 2 - 10;
    var color = d3.scale.category20();

    var arc = d3.svg.arc()
            .innerRadius(radius - 80)
            .outerRadius(radius);

    var pie = d3.layout.pie()
            .padAngle(.02).value(function (d) {
                return d.data_value;
            });
</script>
</body>
</html>
